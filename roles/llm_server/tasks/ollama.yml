---
- name: Ensure prerequisites for Ollama installer
  ansible.builtin.apt:
    name:
      - curl
      - ca-certificates
    state: present
    update_cache: yes

- name: Download Ollama install script
  ansible.builtin.get_url:
    url: "{{ ollama_install_url }}"
    dest: /tmp/ollama-install.sh
    mode: "0755"

- name: Install Ollama
  ansible.builtin.command: /bin/bash /tmp/ollama-install.sh
  args:
    creates: /usr/local/bin/ollama

- name: Ensure Ollama service is running
  ansible.builtin.systemd:
    name: ollama
    enabled: true
    state: started
  register: ollama_service_status
  failed_when: false

- name: Pull requested models
  ansible.builtin.command: "ollama pull {{ item }}"
  environment:
    OLLAMA_HOST: "127.0.0.1"
  loop: "{{ ollama_models }}"
  when: ollama_models | length > 0
  register: ollama_model_pull
  changed_when: "'downloaded' in ollama_model_pull.stdout | default('')"
  failed_when: false
