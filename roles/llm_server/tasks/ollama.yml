---
- name: Ensure snapd is present
  ansible.builtin.apt:
    name: snapd
    state: present
    update_cache: yes

- name: Ensure snapd socket active
  ansible.builtin.systemd:
    name: snapd.socket
    state: started
    enabled: true
  when: ansible_service_mgr == "systemd"

- name: Install Ollama via snap
  ansible.builtin.command: snap install --classic ollama
  args:
    creates: /snap/bin/ollama
  register: ollama_snap_install
  changed_when: "'already installed' not in (ollama_snap_install.stdout | default('') ~ ollama_snap_install.stderr | default(''))"
  failed_when: false

- name: Create systemd unit for Ollama serve
  ansible.builtin.copy:
    dest: /etc/systemd/system/ollama.service
    mode: "0644"
    content: |
      [Unit]
      Description=Ollama LLM Service
      After=network.target

      [Service]
      Type=simple
      ExecStart=/snap/bin/ollama serve
      Restart=on-failure
      User=root
      Group=root

      [Install]
      WantedBy=multi-user.target
  when: ansible_service_mgr == "systemd"

- name: Reload systemd for Ollama unit
  ansible.builtin.systemd:
    daemon_reload: true
  when: ansible_service_mgr == "systemd"

- name: Ensure Ollama service is running
  ansible.builtin.systemd:
    name: ollama.service
    enabled: true
    state: started
  when: ansible_service_mgr == "systemd"

- name: Pull requested models
  ansible.builtin.command: "/snap/bin/ollama pull {{ item }}"
  environment:
    OLLAMA_HOST: "127.0.0.1"
  loop: "{{ ollama_models }}"
  when: ollama_models | length > 0
  register: ollama_model_pull
  changed_when: "'downloaded' in ollama_model_pull.stdout | default('')"
  failed_when: false
